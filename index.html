<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sina AI - Premium Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
		 
:root {
    --neon-green: #39ff14;
    --accent-glow: rgba(57, 255, 20, 0.2);
    --bg-deep: #000000; /* Ensure this is black */
    --sidebar-bg: #000000; /* Changed from #090909 to black */
    --card-bg: #111111;
    --border-subtle: #1f1f1f;
    --text-main: #f5f5f7;
    --text-muted: #86868b;
}

* { box-sizing: border-box; -webkit-font-smoothing: antialiased; }

body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-deep);
    color: var(--text-main);
    height: 100vh; width: 100vw;
    display: flex; overflow: hidden;
}

/* --- 1. OCEANIC AUTH OVERLAY --- */
#auth-overlay {
    background: #000000 !important; /* Changed from radial-gradient */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}





/* --- 2. AUTH CARD (UNDERSEA TERMINAL) --- */
.auth-card {
    position: relative;
    z-index: 10;
    background: rgba(0, 5, 5, 0.75) !important;
    border: 1px solid rgba(57, 255, 20, 0.25) !important;
    backdrop-filter: blur(25px) !important;
    -webkit-backdrop-filter: blur(25px);
    border-radius: 32px;
    padding: 50px;
    width: 100%;
    max-width: 440px;
    text-align: center;
    box-shadow: 0 25px 100px rgba(0, 0, 0, 0.9);
    animation: float-sea 7s ease-in-out infinite;
    transition: opacity 0.3s ease;
}

@keyframes float-sea {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(0.8deg); }
}

#auth-title {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 8px;
    font-weight: 900;
    letter-spacing: 5px;
    font-size: 1.8rem;
    color: var(--neon-green);
    text-transform: uppercase;
}

#auth-title span {
    color: #ffffff;
    text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
}

.auth-subtitle {
    color: #557777;
    font-family: 'JetBrains Mono';
    font-size: 0.75rem;
    margin-bottom: 35px;
    letter-spacing: 2px;
}

.auth-input {
    width: 100%;
    background: rgba(0, 0, 0, 0.5) !important;
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    padding: 18px;
    margin-bottom: 15px;
    border-radius: 14px;
    color: white !important;
    font-family: 'JetBrains Mono';
    transition: all 0.4s ease;
    outline: none;
}

.auth-input:focus {
    border-color: var(--neon-green) !important;
    box-shadow: 0 0 20px rgba(57, 255, 20, 0.15);
    background: rgba(0, 0, 0, 0.7) !important;
}

.auth-btn {
    width: 100%;
    padding: 18px;
    background: var(--neon-green);
    color: #000;
    border: none;
    border-radius: 14px;
    font-weight: 900;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.3s ease;
}

.auth-btn:hover {
    box-shadow: 0 0 25px var(--neon-green);
    transform: translateY(-2px);
    letter-spacing: 4px;
}

.toggle-link { display: block; margin-top: 20px; color: var(--text-muted); font-size: 0.75rem; text-decoration: underline; cursor: pointer; }

/* --- 3. MAIN APPLICATION UI --- */
#app-content { visibility: hidden; width: 100%; height: 100%; display: none; }

aside {
    width: 280px; background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-subtle);
    display: flex; flex-direction: column; padding: 24px 16px; flex-shrink: 0;
}

.user-tag-box { background: #0a0a0a; padding: 16px; border-radius: 14px; border: 1px solid var(--border-subtle); margin-bottom: 24px; }

.side-btn {
    width: 100%; padding: 12px; border-radius: 10px; font-size: 0.7rem;
    font-weight: 800; cursor: pointer; text-transform: uppercase;
    letter-spacing: 1px; margin-top: 10px; transition: all 0.2s;
}
.btn-login { background: transparent; border: 1px solid var(--neon-green); color: var(--neon-green); }
.btn-login:hover { background: var(--neon-green); color: black; }
.btn-terminate { background: #1a0000; border: 1px solid #300; color: #ff4444; }

main { flex: 1; display: flex; flex-direction: column; position: relative; }

header {
    padding: 18px 30px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
}

.vault-trigger {
    width: 42px; height: 42px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s;
    border: 1px solid var(--border-subtle); background: #111; color: var(--text-main);
}
.vault-trigger:hover { border-color: var(--neon-green); color: var(--neon-green); transform: translateY(-2px); }

#chat-window { flex: 1; overflow-y: auto; padding-bottom: 140px; }
.message-row { padding: 24px 10%; display: flex; border-bottom: 1px solid rgba(255,255,255,0.02); }
.ai-avatar { background: var(--neon-green); color: black; width: 34px; height: 34px; border-radius: 8px; margin-right: 24px; display: flex; align-items: center; justify-content: center; font-weight: 800; }
.user-avatar { background: #222; color: #888; width: 34px; height: 34px; border-radius: 8px; margin-right: 24px; display: flex; align-items: center; justify-content: center; font-weight: 800; }
.message-content { flex: 1; line-height: 1.7; font-size: 0.95rem; white-space: pre-wrap; }

.input-area { position: absolute; bottom: 0; left: 0; right: 0; padding: 30px 10%; background: linear-gradient(transparent, var(--bg-deep) 60%); }
.input-container { max-width: 1000px; margin: 0 auto; background: #0f0f0f; border: 1px solid var(--border-subtle); border-radius: 18px; padding: 12px 20px; display: flex; align-items: center; gap: 18px; }
textarea { flex: 1; background: transparent; border: none; color: white; outline: none; resize: none; font-family: inherit; font-size: 0.95rem; }

#file-preview-container {
    display: none; padding: 10px; background: #111;
    border-top: 1px solid var(--border-subtle); border-radius: 12px 12px 0 0;
    margin-bottom: -5px; position: relative;
}
.preview-thumbnail { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--neon-green); }
.remove-file { position: absolute; top: 5px; left: 65px; background: red; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; }

#vault-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); z-index: 10000; display: none; flex-direction: column; }
		 /* Futuristic Background "S" Beacon */
#vault-items::before {
    content: "S";
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 45vw;
    font-weight: 900;
    /* This gradient creates the shiny metallic "Target" */
    background: linear-gradient(135deg, rgba(57,255,20,0.01) 0%, rgba(255,255,255,0.2) 50%, rgba(57,255,20,0.01) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    pointer-events: none;
    z-index: 1;
    animation: metallic-shine 6s linear infinite;
}

@keyframes metallic-shine { to { background-position: 200% center; } }
		
    </style>
</head>
	
<body>

<div id="auth-overlay">
    <canvas id="s-canvas" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>

    <div class="auth-card">
        <h1 id="auth-title">SINA <span>ULTRA</span></h1>
        <div id="auth-subtitle" class="auth-subtitle">Welcome back, Operator.</div>
        <input type="text" id="auth-user" class="auth-input" placeholder="Unique Neural ID">
        <input type="password" id="auth-pass" class="auth-input" placeholder="Access Key">
        <button id="auth-primary-btn" class="auth-btn" onclick="handleAuth()">Establish Link</button>
        <span class="toggle-link" id="auth-toggle" onclick="toggleAuthMode()">No ID? Register New Identity</span>
        <div id="auth-error" style="color:#ff4444; font-size:0.75rem; margin-top:15px; font-weight:500;"></div>
    </div>
</div>

<div id="app-content">
    <aside>
        <div class="user-tag-box">
            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px;">Identity</div>
            <div id="user-display" style="font-weight: 700; font-family: 'JetBrains Mono'; color: var(--neon-green); font-size: 1.1rem;">--</div>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 15px;">
			  <button class="side-btn btn-login" onclick="toggleSettings()" style="border-color: #555; color: #aaa;">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="margin-right: 5px; vertical-align: middle;">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
    System Settings
</button>
        </div>

        <div style="margin-top: auto;">
            <button class="side-btn btn-login" onclick="forceLoginScreen()">Log Out</button>
            <button class="side-btn btn-terminate" onclick="terminateSession()">Terminate</button>
        </div>
    </aside>

    <main>
       <header>
    <div style="font-weight: 900; letter-spacing: 3px;">SINA <span style="color:var(--neon-green)">ULTRA</span></div>
    
    <div style="display: flex; gap: 15px; align-items: center;">
        <div class="vault-trigger" onclick="toggleCallInterface()" title="Establish Voice Link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
        </div>

        <div class="vault-trigger" onclick="toggleVault()">               
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
            </svg>
        </div>
    </div>
</header>

        <div id="chat-window"></div>

        <div class="input-area">
            <div id="file-preview-container">
                <img id="file-preview-img" class="preview-thumbnail">
                <button class="remove-file" onclick="clearFile()">âœ•</button>
            </div>
            <div class="input-container">
                <label style="cursor:pointer; color: #555;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    <input type="file" id="fileInput" style="display:none" onchange="handleFileSelect(this)">
                </label>
                <textarea id="userInput" placeholder="Type a message..." rows="1" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendPrompt();}"></textarea>
                <div onclick="sendPrompt()" style="cursor:pointer; color: var(--neon-green)">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13"></path><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="vault-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); z-index: 10000; flex-direction: column;">
    <header style="border-bottom: 1px solid var(--border-subtle); background: var(--sidebar-bg); padding: 20px 30px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div onclick="toggleVault()" style="cursor: pointer; color: var(--neon-green); display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; font-weight: bold;">BACK TO TERMINAL</span>
            </div>
            <h2 style="color: white; font-family: 'Inter'; margin: 0; font-size: 1.1rem; letter-spacing: 2px;">NEURAL ARCHIVE // STORAGE</h2>
        </div>
    </header>

    <div style="flex: 1; overflow-y: auto; padding: 40px 10%;">
        <div id="vault-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
            </div>
    </div>
</div>

<div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); z-index: 10001; flex-direction: column;">
    <header style="border-bottom: 1px solid var(--border-subtle); background: var(--sidebar-bg); padding: 20px 30px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div onclick="toggleSettings()" style="cursor: pointer; color: var(--neon-green); display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; font-weight: bold;">BACK TO TERMINAL</span>
            </div>
            <h2 style="color: white; font-family: 'Inter'; margin: 0; font-size: 1.1rem; letter-spacing: 2px;">SYSTEM // SETTINGS</h2>
        </div>
    </header>

    <div style="flex: 1; padding: 40px 10%; background: #000000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 30px;">
            
            <div style="background: #0a0a0a; border: 1px solid var(--border-subtle); border-radius: 24px; padding: 40px; box-shadow: 0 0 50px rgba(57, 255, 20, 0.05);">
                <h3 style="color: var(--neon-green); font-family: 'JetBrains Mono'; margin-top: 0; font-size: 0.9rem; letter-spacing: 1px;">EMERGENCY WIFI PROTOCOL</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                    Use this protocol only in dead-zones. This will attempt to bridge surrounding Wi-Fi signals into a single high-bandwidth stream.
                </p>
                
                <div id="wifi-status" style="margin: 25px 0; padding: 15px; background: #000; border-radius: 12px; border: 1px dashed #333; font-family: 'JetBrains Mono'; font-size: 0.75rem; color: #555;">
                    STATUS: OFFLINE
                </div>

                <button class="auth-btn" onclick="executeWifiUplink()">INITIATE UPLINK</button>
            </div>

            <div style="background: #0a0a0a; border: 1px solid var(--border-subtle); border-radius: 24px; padding: 40px; box-shadow: 0 0 50px rgba(255, 255, 255, 0.02);">
                <h3 style="color: #ffffff; font-family: 'JetBrains Mono'; margin-top: 0; font-size: 0.9rem; letter-spacing: 1px;">NEURAL BROADCAST</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                    Generate a high-frequency QR code to bridge this terminal session with another hardware node.
                </p>
                
                <button class="auth-btn" style="margin-top: 10px; background: #ffffff; color: #000; display: flex; align-items: center; justify-content: center; gap: 12px;" onclick="openSharePage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                        <polyline points="16 6 12 2 8 6"></polyline>
                        <line x1="12" y1="2" x2="12" y2="15"></line>
                    </svg>
                    SHARE TERMINAL
                </button>
            </div>

        </div>
    </div>
</div>
    
<div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); z-index: 10005; flex-direction: column;">
    <header style="border-bottom: 1px solid var(--border-subtle); background: var(--sidebar-bg); padding: 20px 30px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div onclick="closeSharePage()" style="cursor: pointer; color: var(--neon-green); display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; font-weight: bold;">BACK TO SETTINGS</span>
            </div>
            <h2 style="color: white; font-family: 'Inter'; margin: 0; font-size: 1.1rem; letter-spacing: 2px;">NEURAL // BROADCAST</h2>
        </div>
    </header>

    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
        <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 0 40px var(--accent-glow); margin-bottom: 30px;">
            <div id="qrcode"></div>
        </div>
        <h3 style="color: var(--neon-green); font-family: 'JetBrains Mono'; margin-bottom: 10px;">SCAN TO BRIDGE DEVICES</h3>
        <p style="color: var(--text-muted); text-align: center; max-width: 300px; font-size: 0.85rem;">
            Scan this encrypted QR to instantly transfer this terminal instance to another neural node.
        </p>
    </div>
</div>
	
<script>
// 1. Function to show/hide the settings page
function toggleSettings() {
    const settingsModal = document.getElementById('settings-modal');
    const appContent = document.getElementById('app-content');
    
    if (settingsModal.style.display === 'none' || settingsModal.style.display === '') {
        appContent.style.display = 'none';
        settingsModal.style.display = 'flex';
    } else {
        settingsModal.style.display = 'none';
        appContent.style.display = 'flex';
    }
}
</script>
	

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loader-small {
        width: 14px; height: 14px; border: 2px solid var(--neon-green);
        border-bottom-color: transparent; border-radius: 50%;
        display: inline-block; animation: rotation 1s linear infinite;
    }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>



	<div id="call-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #051005 0%, #000 100%); z-index: 10002; flex-direction: column; align-items: center; justify-content: center;">
    <div style="text-align: center;">
        <div id="call-avatar" style="width: 120px; height: 120px; border-radius: 50%; background: var(--neon-green); margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: black; font-weight: 900; box-shadow: 0 0 50px var(--accent-glow); animation: pulse 2s infinite;">S</div>
        <h2 id="call-status" style="color: var(--neon-green); font-family: 'JetBrains Mono'; letter-spacing: 4px;">ESTABLISHING VOICE LINK...</h2>
        <p id="transcript-preview" style="color: var(--text-muted); font-family: 'JetBrains Mono'; margin-top: 20px; font-size: 0.9rem; max-width: 400px;"></p>
    </div>

    <button onclick="endVoiceCall()" style="margin-top: 80px; background: #ff4444; border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white;">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
</div>

<style>
@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 20px var(--accent-glow); }
    50% { transform: scale(1.05); box-shadow: 0 0 60px var(--accent-glow); }
    100% { transform: scale(1); box-shadow: 0 0 20px var(--accent-glow); }
}
</style>


	
<script>
    // 1. ADD YOUR API KEY HERE
    const apiKey = "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"; 

    let selectedFileBase64 = null;
    let selectedFileType = null;

    function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;

        selectedFileType = file.type;
        const reader = new FileReader();
        reader.onload = (e) => {
            selectedFileBase64 = e.target.result.split(',')[1];
            
            // Show preview for images
            if (file.type.startsWith('image/')) {
                document.getElementById('file-preview-container').style.display = 'block';
                document.getElementById('file-preview-img').src = e.target.result;
            } else {
                // For audio/video just show a generic icon or text
                document.getElementById('file-preview-container').style.display = 'block';
                document.getElementById('file-preview-img').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z'%3E%3C/path%3E%3Cpolyline points='13 2 13 9 20 9'%3E%3C/polyline%3E%3C/svg%3E";
            }
        };
        reader.readAsDataURL(file);
    }

    function clearFile() {
        selectedFileBase64 = null;
        selectedFileType = null;
        document.getElementById('fileInput').value = "";
        document.getElementById('file-preview-container').style.display = 'none';
    }


    function appendMsg(text, type, id) {
        const win = document.getElementById('chat-window');
        const row = document.createElement('div');
        row.className = `message-row`;
        if (id) row.id = id;async function sendPrompt() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    
    if (!text && !selectedFileBase64) return;
    
    const fileName = document.getElementById('fileInput').files[0]?.name || "Document";
    
    appendMsg(text || `Uploading ${fileName}...`, 'user');
    input.value = "";
    
    const aiId = 'ai-' + Date.now();
    appendMsg('Neural Processing...', 'ai', aiId);

    try {
        if (selectedFileBase64) {
            // Save to LocalStorage/DB
            saveToVault({
                name: fileName,
                type: selectedFileType,
                data: selectedFileBase64,
                is_file: true
            });
            
            updateMsg(aiId, `The ${fileName} has been successfully uploaded to your Neural Archive.`);
            clearFile();

            // REFRESH VAULT IF OPEN: This ensures the file appears immediately
            const archivePage = document.getElementById('vault-modal');
            if (archivePage.style.display === 'flex') {
                toggleVault(); // Close
                toggleVault(); // Re-open to rebuild the list
            }
            return; 
        }

        const res = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}` 
            },
            body: JSON.stringify({ 
                model: "llama-3.3-70b-versatile",
                messages: [{ role: "user", content: text }],
                temperature: 0.7
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);

        if (data.choices && data.choices[0]) {
            updateMsg(aiId, data.choices[0].message.content);
        }
    } catch (e) {
        updateMsg(aiId, "Neural Link Failure: " + e.message);
    }
}
        row.innerHTML = `<div class="${type}-avatar">${type[0].toUpperCase()}</div><div class="message-content">${text}</div>`;
        win.appendChild(row);
        win.scrollTop = win.scrollHeight;
    }

    function updateMsg(id, text) {
        const el = document.getElementById(id);
        if (el) el.querySelector('.message-content').innerText = text;
    }

// --- SESSION MANAGEMENT ---

// Run this as soon as the script loads
checkExistingSession();



// --- AUTHENTICATION MODE LOGIC ---
let isLoginMode = true;

function toggleAuthMode() {
    isLoginMode = !isLoginMode;
    const card = document.querySelector('.auth-card');
    const title = document.getElementById('auth-title');
    const subtitle = document.getElementById('auth-subtitle');
    const primaryBtn = document.getElementById('auth-primary-btn');
    const toggleLink = document.getElementById('auth-toggle');

    card.style.opacity = '0';

    setTimeout(() => {
        if (isLoginMode) {
            // Replace the innerHTML to include the span for the second word
            title.innerHTML = `SINA <span>ULTRA</span>`;
            subtitle.innerText = "LOGIN";
            primaryBtn.innerText = "Establish Link";
            toggleLink.innerText = "No ID? Register New Identity";
        } else {
            // Replace the innerHTML to include the span for the second word
            title.innerHTML = `SINA <span>ULTRA</span>`;
            subtitle.innerText = "SIGN IN";
            primaryBtn.innerText = "Register Identity";
            toggleLink.innerText = "Already have an ID? Access Terminal";
        }
        card.style.opacity = '1';
    }, 300);
}

// Call it once on page load to set the initial "SINA LOGIN" state
toggleAuthMode();

function handleAuth() {
    const btn = document.getElementById('auth-primary-btn');
    const id = document.getElementById('auth-user').value.trim().toLowerCase();
    const pass = document.getElementById('auth-pass').value.trim();
    const errorEl = document.getElementById('auth-error');
    const userDB = JSON.parse(localStorage.getItem('sina_user_db')) || {};

    if (!id || !pass) {
        errorEl.innerText = "CRITICAL: Neural ID and Access Key required.";
        return;
    }

    // Add "Loading" beauty
    const originalText = btn.innerText;
    btn.innerText = "SYNCING...";
    btn.style.opacity = "0.7";

    setTimeout(() => {
        if (isLoginMode) {
            if (!userDB[id]) {
                errorEl.innerText = "ACCESS DENIED: Identity not found.";
            } else if (userDB[id].password !== pass) {
                errorEl.innerText = "ACCESS DENIED: Invalid Access Key.";
            } else {
                localStorage.setItem('sina_session', id);
                applyLoginUI(id);
            }
        } else {
            if (userDB[id]) {
                errorEl.innerText = "ERROR: Identity already registered.";
            } else {
                userDB[id] = { password: pass, vault: [], history: [] };
                localStorage.setItem('sina_user_db', JSON.stringify(userDB));
                localStorage.setItem('sina_session', id);
                applyLoginUI(id);
            }
        }
        btn.innerText = originalText;
        btn.style.opacity = "1";
    }, 800); // Small delay to show off the "Syncing" state
}

// --- 1. IMPROVED SESSION LOCK ---
// This runs immediately. If a session exists, it locks the UI to that user.
checkExistingSession();

function checkExistingSession() {
    const savedUser = localStorage.getItem('sina_session');
    if (savedUser) {
        applyLoginUI(savedUser);
    }
}

	
// --- 2. ENHANCED AUTHENTICATION (Login & Register) ---


function applyLoginUI(id) {
    document.getElementById('auth-overlay').style.display = 'none';
    document.getElementById('app-content').style.display = 'flex';
    document.getElementById('app-content').style.visibility = 'visible';
    document.getElementById('user-display').innerText = id.toUpperCase();
}

function forceLoginScreen() {
    // Clear the stored session
    localStorage.removeItem('sina_session');
    // Reload the page to reset all states
    window.location.reload();
}

function terminateSession() {
    if(confirm("Terminate all neural links and wipe local cache?")) {
        localStorage.clear();
        window.location.reload();
    }
}

	function saveToVault(content) {
    const currentUser = localStorage.getItem('sina_session');
    let userDB = JSON.parse(localStorage.getItem('sina_user_db')) || {};

    if (currentUser && userDB[currentUser]) {
        // Ensure the vault array exists
        if (!userDB[currentUser].vault) userDB[currentUser].vault = [];
        
        userDB[currentUser].vault.push({
            content: content,
            timestamp: new Date().toLocaleString()
        });
        
        localStorage.setItem('sina_user_db', JSON.stringify(userDB));
        console.log("Archive Synchronized.");
    } else {
        console.error("No active session found for storage.");
    }
}

function toggleVault() {
    const archivePage = document.getElementById('vault-modal');
    const mainApp = document.getElementById('app-content');
    const container = document.getElementById('vault-items');
    
    // If we are opening the Vault
    if (archivePage.style.display === 'none' || archivePage.style.display === '') {
        mainApp.style.display = 'none';
        archivePage.style.display = 'flex';
        
        // 1. BROADCAST & LISTEN (Zero-Click Protocol)
        // This makes the device visible to any Sender's camera
        if (typeof startPassiveReceivingMode === "function") {
            startPassiveReceivingMode();
        }

        const data = getVaultData();
        
        // 2. CLEAR CONTAINER
        // Ensures the "Empty" message doesn't get stuck behind new files
        container.innerHTML = ""; 
        
        if (data.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; margin-top: 100px; z-index: 2;">
                    <p style="color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.9rem;">NEURAL ARCHIVE EMPTY</p>
                    <p style="color: #333; font-size: 0.7rem;">UPLOAD VIA TERMINAL OR WAIT FOR INCOMING BEAM</p>
                </div>`;
            return;
        }

        // 3. GENERATE FILE CARDS
        data.forEach((item) => {
            const isFile = typeof item.content === 'object' && item.content.is_file;
            const displayName = isFile ? item.content.name : "Text Record";
            const displayBody = isFile ? `TYPE: ${item.content.type}` : item.content;

            container.innerHTML += `
                <div ondblclick='initiateVisualBeam(${JSON.stringify(item.content)})' 
                     style="background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(57, 255, 20, 0.1); padding: 20px; border-radius: 16px; cursor: pointer; transition: 0.3s; position: relative; z-index: 10;"
                     onmouseover="this.style.borderColor='var(--neon-green)';" 
                     onmouseout="this.style.borderColor='rgba(57, 255, 20, 0.1)';"
                >
                    <div style="color: var(--neon-green); font-family: 'JetBrains Mono'; font-size: 0.6rem; margin-bottom: 15px; display: flex; justify-content: space-between;">
                        <span>${item.timestamp}</span>
                        <span style="opacity: 0.5; letter-spacing: 1px;">DBL-CLICK TO BEAM</span>
                    </div>
                    <div style="color: white; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${displayName}</div>
                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 20px;">
                        ${displayBody}
                    </div>
                    <div style="display: flex; justify-content: flex-end;">
                        ${isFile ? 
                            `<button onclick="event.stopPropagation(); downloadFile('${item.content.data}', '${item.content.name}', '${item.content.type}')" style="background: var(--neon-green); border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: bold; color: black;">DOWNLOAD</button>` : 
                            `<button onclick="event.stopPropagation(); copyRecord(this)" style="background: none; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 5px 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">COPY</button>`
                        }
                    </div>
                </div>
            `;
        });
    } else {
        // 4. CLOSING THE VAULT
        archivePage.style.display = 'none';
        mainApp.style.display = 'flex';
        
        // STOP BROADCASTING & LISTENING
        // Removes the "Active Beacon" so this device is no longer targeted
        localStorage.removeItem('active_beacon'); 
        if (window.receiveCheckInterval) {
            clearInterval(window.receiveCheckInterval);
        }
    }
}

// NEW FUNCTION TO DOWNLOAD THE STORED BOOK
function downloadFile(base64, name, type) {
    const link = document.createElement('a');
    link.href = `data:${type};base64,${base64}`;
    link.download = name;
    link.click();
}

// Helper to copy text from a card
function copyRecord(btn) {
    const text = btn.parentElement.parentElement.querySelector('div:nth-child(2)').innerText;
    navigator.clipboard.writeText(text);
    const original = btn.innerText;
    btn.innerText = "COPIED!";
    btn.style.color = "var(--neon-green)";
    setTimeout(() => { btn.innerText = original; btn.style.color = "var(--text-muted)"; }, 2000);
}

	function getVaultData() {
    const currentUser = localStorage.getItem('sina_session');
    // Get the database or return an empty object if it doesn't exist
    const userDB = JSON.parse(localStorage.getItem('sina_user_db')) || {};
    
    // Return the vault array for the current user, or an empty array if not found
    return userDB[currentUser]?.vault || [];
}

function triggerWifiProtocol() {
    const currentUser = localStorage.getItem('sina_session');
    const userDB = JSON.parse(localStorage.getItem('sina_user_db')) || {};
    const statusEl = document.getElementById('wifi-status');

    if (!currentUser || !userDB[currentUser]) {
        alert("CRITICAL ERROR: No active identity found.");
        return;
    }

    // Request the password (Neural Access Key)
    const accessKey = prompt("SECURITY CHALLENGE: Enter your Access Key to authorize emergency uplink.");

    if (accessKey === userDB[currentUser].password) {
        statusEl.innerHTML = "STATUS: <span style='color: var(--neon-green)'>AUTHORIZING...</span>";
        statusEl.style.color = "var(--text-main)";

        // Simulated connection sequence for competition aesthetics
        setTimeout(() => {
            statusEl.innerText = "SEARCHING FOR LOCAL NODES...";
            setTimeout(() => {
                statusEl.innerHTML = "STATUS: <span style='color: var(--neon-green)'>EMERGENCY UPLINK ESTABLISHED</span>";
                alert("Neural Uplink Authorized. Emergency Wi-Fi simulated for terminal competition.");
            }, 2000);
        }, 1500);
        
    } else {
        statusEl.innerHTML = "STATUS: <span style='color: #ff4444'>ACCESS DENIED</span>";
        alert("INCORRECT ACCESS KEY: Unauthorized attempt logged.");
    }
}

	async function executeWifiUplink() {
    const statusEl = document.getElementById('wifi-status');
    const currentUser = localStorage.getItem('sina_session');
    const userDB = JSON.parse(localStorage.getItem('sina_user_db')) || {};

    // 1. Session Validation
    if (!currentUser || !userDB[currentUser]) {
        alert("CRITICAL: No active Neural Identity found to authorize uplink.");
        return;
    }

    // 2. Password Challenge
    const accessKey = prompt("SECURITY CHALLENGE: Enter Neural Access Key to bridge local Wi-Fi nodes.");
    
    // Validate against the stored password for the current session
    if (accessKey !== userDB[currentUser].password) {
        statusEl.innerHTML = "STATUS: <span style='color: #ff4444'>CREDENTIAL MISMATCH</span>";
        return;
    }

    // 3. Functional Simulation of Hardware Interfacing
    statusEl.innerHTML = "STATUS: <span style='color: var(--neon-green)'>INJECTING NEURAL PACKETS...</span>";
    
    try {
        // Checking for actual internet connectivity via a ping test
        const response = await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
        
        setTimeout(() => {
            statusEl.innerHTML = "STATUS: <span style='color: var(--neon-green)'>UPLINK ACTIVE (STRENGTH: 98%)</span>";
            appendMsg("Emergency Wi-Fi bridge established. Local hardware nodes successfully bypassed.", "ai");
        }, 2000);
    } catch (error) {
        // If fetch fails, we simulate the 'Emergency' bypass for the competition
        setTimeout(() => {
            statusEl.innerHTML = "STATUS: <span style='color: #ffcc00'>EMERGENCY TUNNEL ESTABLISHED</span>";
            appendMsg("Hardware blocked direct access. Virtual Neural Tunnel activated.", "ai");
        }, 2000);
    }
}

	async function sendPrompt() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    
    // 1. Check if we have input or a file
    if (!text && !selectedFileBase64) return;
    
    const fileName = document.getElementById('fileInput').files[0]?.name || "Document";
    
    // 2. UI Update
    appendMsg(text || `Uploading ${fileName}...`, 'user');
    input.value = "";
    
    const aiId = 'ai-' + Date.now();
    appendMsg('Neural Processing...', 'ai', aiId);

    try {
        // --- VAULT UPLOAD LOGIC ---
        if (selectedFileBase64) {
            saveToVault({
                name: fileName,
                type: selectedFileType,
                data: selectedFileBase64,
                is_file: true
            });
            
            updateMsg(aiId, `The ${fileName} has been successfully uploaded to your Neural Archive.`);
            clearFile();
            return; 
        }

        // --- AI API LOGIC ---
        // Ensure apiKey is defined at the top of your script!
        const res = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}` // Ensure this variable exists
            },
            body: JSON.stringify({ 
                model: "llama-3.3-70b-versatile",
                messages: [{ role: "user", content: text }],
                temperature: 0.7
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);

        if (data.choices && data.choices[0]) {
            updateMsg(aiId, data.choices[0].message.content);
        }
    } catch (e) {
        updateMsg(aiId, "Neural Link Failure: " + e.message);
    }
}


	// --- SENDER: Double Click Logic ---
async function initiateVisualBeam(fileContent) {
    if(!document.getElementById('visual-bridge')) createBridgeUI();
    
    document.getElementById('vault-modal').style.display = 'none';
    const bridge = document.getElementById('visual-bridge');
    bridge.style.display = 'flex';
    const status = document.getElementById('bridge-status');
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('bridge-video').srcObject = stream;
        document.getElementById('bridge-video').play();

        status.innerText = "SENSING NEURAL FREQUENCIES...";

        // AUTOMATIC DETECTION: No prompts
        setTimeout(() => {
            const targetID = localStorage.getItem('active_beacon');
            
            if (targetID) {
                status.innerText = `LOCK ACQUIRED: ${targetID.toUpperCase()}`;
                status.style.color = "white";

                // BEAMING DATA
                localStorage.setItem('neural_handshake', JSON.stringify({
                    target: targetID,
                    file: fileContent
                }));

                // Success Animation
                setTimeout(() => {
                    status.innerText = "BEAM COMPLETE";
                    setTimeout(() => closeBridge(), 1000);
                }, 1000);
            } else {
                status.innerText = "NO TARGET DETECTED. ALIGN SCREENS.";
                status.style.color = "red";
                setTimeout(() => closeBridge(), 2000);
            }
        }, 2000); // 2 seconds to "find" the target

    } catch (err) {
        alert("Camera Error: " + err.message);
        closeBridge();
    }
}

function closeBridge() {
    const bridge = document.getElementById('visual-bridge');
    if(bridge) bridge.style.display = 'none';
    const video = document.getElementById('bridge-video');
    if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
    }
}

function createBridgeUI() {
    const bridgeDiv = document.createElement('div');
    bridgeDiv.id = 'visual-bridge';
    bridgeDiv.style = "display:none; position:fixed; inset:0; background:#000; z-index:20000; flex-direction:column;";
    bridgeDiv.innerHTML = `
        <video id="bridge-video" style="width:100%; height:70vh; object-fit:cover;"></video>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#39ff14; font-family:'JetBrains Mono';">
            <p id="bridge-status">SCANNING FOR BEACON...</p>
            <button onclick="closeBridge()" class="auth-btn" style="width:200px; background:#333; color:white;">CANCEL</button>
        </div>
    `;
    document.body.appendChild(bridgeDiv);
}



	function startPassiveReceivingMode() {
    const currentUser = localStorage.getItem('sina_session');
    if (!currentUser) return;

    // 1. ANNOUNCE: Tell the network "I am currently looking at my Vault"
    localStorage.setItem('active_beacon', currentUser);

    // 2. LISTEN: Check for incoming files
    if (window.receiveCheckInterval) clearInterval(window.receiveCheckInterval);
    window.receiveCheckInterval = setInterval(() => {
        const handshake = JSON.parse(localStorage.getItem('neural_handshake'));
        if (handshake && handshake.target === currentUser) {
            saveToVault(handshake.file);
            
            // Visual feedback
            document.body.style.boxShadow = "inset 0 0 100px var(--neon-green)";
            setTimeout(() => document.body.style.boxShadow = "none", 1000);
            
            localStorage.removeItem('neural_handshake');
            toggleVault(); toggleVault(); // Refresh UI
        }
    }, 1000);
}
</script>



<script>
    const voiceApiKey = "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"; 
	let conversationHistory = [
    { role: "system", content: "You are SINA. You have a perfect memory of this conversation. Keep responses natural, short, and connected to previous topics." }
];
    
    let recognition;
    let isCalling = false;
    let synth = window.speechSynthesis;
    let isProcessing = false; 

    async function toggleCallInterface() {
        const callModal = document.getElementById('call-modal');
        const appContent = document.getElementById('app-content');
        if (callModal.style.display === 'flex') { endVoiceCall(); return; }
        try {
            synth.cancel(); 
            isCalling = true;
            await navigator.mediaDevices.getUserMedia({ audio: true });
            appContent.style.display = 'none';
            callModal.style.display = 'flex';
            document.getElementById('call-status').innerText = "CONNECTED";
            startListening();
        } catch (err) { alert("Mic required."); endVoiceCall(); }
    }

function startListening() {
    if (!isCalling || synth.speaking) return;

    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRec();
    recognition.continuous = false; 
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
        document.getElementById('call-status').innerText = "SINA IS LISTENING...";
        document.getElementById('call-status').style.color = "var(--neon-green)";
    };

    recognition.onresult = (event) => {
        let interim = '';
        let final = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) final += event.results[i][0].transcript;
            else interim += event.results[i][0].transcript;
        }

        // --- BARGE-IN INTERRUPT ---
        // If you speak while SINA is talking, she stops immediately
        if (interim.length > 0 && synth.speaking) {
            synth.cancel();
            document.getElementById('call-status').innerText = "LISTENING...";
        }

        // Update the preview text on screen
        if (interim) {
            document.getElementById('transcript-preview').innerText = `"${interim}..."`;
        }

        if (final.trim().length > 0) {
            document.getElementById('transcript-preview').innerText = `"${final}"`;
            
            // --- 1. CHECK FOR COMMANDS (Like "Open Google") ---
            const isCommand = handleWebCommands(final);
            
            if (isCommand) {
                // If it was a command, we reset processing and wait for next input
                isProcessing = false; 
                // We don't call the AI here because handleWebCommands already did the work
            } else {
                // --- 2. REGULAR CHAT LOGIC ---
                isProcessing = true;
                recognition.stop(); // Stop ears while SINA thinks
                getAIResponse(final).then(speakResponse);
            }
        }
    };

    recognition.onend = () => {
        // Auto-restart if the call is active and SINA isn't busy
        if (isCalling && !synth.speaking && !isProcessing) {
            try { 
                recognition.start(); 
            } catch(e) {
                console.log("Mic restart prevented: already active.");
            }
        }
    };

    try { 
        recognition.start(); 
    } catch(e) {
        console.error("Speech recognition could not start:", e);
    }
}
	
   async function getAIResponse(userText) {
    document.getElementById('call-status').innerText = "SINA ANALYZING...";
    
    // 1. Add your new message to her memory
    conversationHistory.push({ role: "user", content: userText });

    // 2. Keep memory from getting too "heavy" (Keep last 10 messages)
    if (conversationHistory.length > 11) { 
        // We keep the first message (system prompt) and the last 10
        conversationHistory = [conversationHistory[0], ...conversationHistory.slice(-10)];
    }

    try {
        const res = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${voiceApiKey}` 
            },
            body: JSON.stringify({ 
                model: "llama-3.1-8b-instant", // High speed for real-time feel
                messages: conversationHistory, // We send the WHOLE memory now
                temperature: 0.6, 
                max_tokens: 400
            })
        });
        
        const data = await res.json();
        const aiMessage = data.choices[0].message.content;

        // 3. Add SINA's response to her memory so she remembers what she said
        conversationHistory.push({ role: "assistant", content: aiMessage });

        return aiMessage;
    } catch (error) { 
        return "My memory circuit flickered. Could you repeat that?"; 
    }
}

function speakResponse(text) {
    if (!isCalling) return;
    
    const utterance = new SpeechSynthesisUtterance(text.replace(/[*#_]/g, ''));
    
    // Get all available voices
    const voices = synth.getVoices();
    
    // PRIORITY LIST: We look for these high-quality female voices first
    const preferredVoices = [
        "Google US English", 
        "Microsoft Aria Online (Natural)", 
        "Microsoft Jenny Online (Natural)",
        "Samantha", 
        "Victoria",
        "Google UK English Female"
    ];

    let selectedVoice = null;

    // 1. Try to find a match from our beautiful voice list
    for (let name of preferredVoices) {
        selectedVoice = voices.find(v => v.name.includes(name));
        if (selectedVoice) break;
    }

    // 2. Fallback: If no priority voice found, look for ANY female sounding voice
    if (!selectedVoice) {
        selectedVoice = voices.find(v => v.name.toLowerCase().includes('female') || v.lang.includes('en-US'));
    }

    if (selectedVoice) {
        utterance.voice = selectedVoice;
    }

    // Settings for a "Beautiful" tone
    utterance.rate = 0.95;  // Slightly slower sounds more natural/elegant
    utterance.pitch = 1.1; // Slightly higher pitch for a clear female tone

    // --- HEARTBEAT FIX (Keep-Alive) ---
    const keepAlive = setInterval(() => {
        if (!synth.speaking) {
            clearInterval(keepAlive);
        } else {
            synth.pause();
            synth.resume();
        }
    }, 5000);

    utterance.onstart = () => {
        isProcessing = false;
        document.getElementById('call-status').innerText = "SINA SPEAKING...";
        document.getElementById('call-status').style.color = "white";
    };

    utterance.onend = () => {
        clearInterval(keepAlive);
        if (isCalling) {
            setTimeout(startListening, 400);
        }
    };

    synth.speak(utterance);
}
	
function endVoiceCall() {
    // 1. Stop the internal calling state
    isCalling = false;
    isProcessing = false;

    // 2. Kill the microphone and prevent it from auto-restarting
    if (recognition) {
        recognition.onend = null; // Important: breaks the restart loop
        recognition.abort();      // Immediately stops the mic
    }

    // 3. Stop SINA from speaking mid-sentence
    synth.cancel(); 

    // 4. Reset Memory (Optional)
    // If you want SINA to forget everything and start fresh for the NEXT call:
    // conversationHistory = [conversationHistory[0]]; 
    
    // If you want her to remember you even after you hang up and call back,
    // just leave the line above commented out!

    // 5. Switch the UI back to the main screen
    document.getElementById('call-modal').style.display = 'none';
    document.getElementById('app-content').style.display = 'flex';
    
    // 6. Reset status text for the next time the modal opens
    document.getElementById('call-status').innerText = "DISCONNECTED";
    document.getElementById('transcript-preview').innerText = "Call ended.";
}





function handleWebCommands(transcript) {
    const text = transcript.toLowerCase().trim();


	if (text.includes("sing a song")) {
        sinaSingSong();
        return true; 
    }
	
    if (text.startsWith("open ")) {
        let siteName = text.replace("open ", "").trim();
        siteName = siteName.replace(/[.?]/g, ""); // Clean punctuation

        // Common website mapping
        const favorites = {
            "google": "https://www.google.com",
            "youtube": "https://www.youtube.com",
            "facebook": "https://www.facebook.com",
            "github": "https://github.com",
            "whatsapp": "https://web.whatsapp.com",
            "instagram": "https://www.instagram.com"
        };

        let url;
        if (favorites[siteName]) {
            url = favorites[siteName];
        } else {
            // If not in favorites, use Google's "I'm Feeling Lucky" to find it
            url = `https://www.google.com/search?q=${encodeURIComponent(siteName)}&btnI=I%27m+Feeling+Lucky`;
        }

        window.open(url, "_blank");
        speakResponse(`Opening ${siteName} for you now.`);
        return true; 
    }
    return false; 
}

	// NEW: The Singing Function
function sinaSingSong() {
    const songLines = [
        { text: "Daisy, Daisy,", pitch: 1.3, rate: 0.8 },
        { text: "Give me your answer, do.", pitch: 1.1, rate: 0.8 },
        { text: "I'm half crazy,", pitch: 0.9, rate: 0.8 },
        { text: "all for the love of you.", pitch: 1.0, rate: 0.7 }
    ];

    let lineIndex = 0;
    synth.cancel(); // Stop any current talking

    function nextLine() {
        if (lineIndex < songLines.length && isCalling) {
            const line = songLines[lineIndex];
            const utterance = new SpeechSynthesisUtterance(line.text);
            utterance.pitch = line.pitch;
            utterance.rate = line.rate;
            
            const voices = synth.getVoices();
            utterance.voice = voices.find(v => v.name.includes("Google US English")) || voices[0];

            utterance.onend = () => {
                lineIndex++;
                setTimeout(nextLine, 300); 
            };
            synth.speak(utterance);
        } else {
            isProcessing = false;
            if (typeof startListening === "function") startListening();
        }
    }
    nextLine();
}
	
</script>


<script>
	function openSharePage() {
    // Hide settings, show share modal
    document.getElementById('settings-modal').style.display = 'none';
    const shareModal = document.getElementById('share-modal');
    shareModal.style.display = 'flex';

    // Clear previous QR code if it exists
    const qrContainer = document.getElementById("qrcode");
    qrContainer.innerHTML = "";

    // Generate new QR code for the current URL
    new QRCode(qrContainer, {
        text: window.location.href,
        width: 200,
        height: 200,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
}

function closeSharePage() {
    document.getElementById('share-modal').style.display = 'none';
    document.getElementById('settings-modal').style.display = 'flex';
}
</script>





























	

	
</body>
</html>
